#!/usr/bin/env node

/**
 * –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–µ—Å—Ç—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –Ω–∞ —ç—Ç–∞–ø–µ —Å–±–æ—Ä–∫–∏
 * –°–∫–∞–Ω–∏—Ä—É–µ—Ç –ø–∞–ø–∫–∏ —Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ –∏ —Å–æ–∑–¥–∞–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∫–∞—Ä—Ç—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
 */

const fs = require('fs');
const path = require('path');
const glob = require('glob');

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
const config = {
    // –ü–∞–ø–∫–∏ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
    scanDirs: [
        'src/components/cards/**/*Card/*.tsx',
        'src/components/cards/**/*Card/index.tsx',
        'src/components/**/ui/*.tsx'
    ],
    // –í—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª —Å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
    outputFile: 'src/registry/GeneratedComponentMap.ts',
    // –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
    metadataPatterns: {
        cardName: /export\s+.*Card.*=.*\/\/\s*@card\s+([a-zA-Z0-9_]+)/,
        autoRegister: /@AutoRegister\(['"]([^'"]+)['"]\)/,
        displayName: /@displayName\(['"]([^'"]+)['"]\)/,
        category: /@category\(['"]([^'"]+)['"]\)/
    }
};

/**
 * –°–∫–∞–Ω–∏—Ä—É–µ—Ç —Ñ–∞–π–ª –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
 */
function extractComponentMetadata(filePath) {
    const content = fs.readFileSync(filePath, 'utf8');
    const relativePath = path.relative(process.cwd(), filePath);

    const metadata = {
        filePath: relativePath,
        importPath: relativePath.replace(/\.(tsx?)$/, ''),
        cardName: null,
        displayName: null,
        category: null,
        exportedComponents: []
    };

    // –ò—â–µ–º —ç–∫—Å–ø–æ—Ä—Ç—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
    const exportMatches = content.match(/(export\s+(default\s+)?(?:function|const|class)\s+(\w*Card\w*))/g);
    if (exportMatches) {
        exportMatches.forEach(match => {
            const componentName = match.match(/(\w*Card\w*)/)?.[1];
            if (componentName) {
                metadata.exportedComponents.push(componentName);
            }
        });
    }

    // –ò—â–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö
    Object.entries(config.metadataPatterns).forEach(([key, pattern]) => {
        const match = content.match(pattern);
        if (match) {
            metadata[key] = match[1];
        }
    });

    // –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω cardName, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞
    if (!metadata.cardName && metadata.exportedComponents.length > 0) {
        metadata.cardName = metadata.exportedComponents[0];
    }

    return metadata.cardName ? metadata : null;
}

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç TypeScript —Ñ–∞–π–ª —Å –∫–∞—Ä—Ç–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
 */
function generateComponentMapFile(components) {
    const imports = components
        .map(comp =>
            comp.exportedComponents.length > 1
                ? `import { ${comp.exportedComponents.join(', ')} } from '../${comp.importPath}';`
                : `import ${comp.exportedComponents[0]} from '../${comp.importPath}';`
        )
        .join('\n');

    const componentEntries = components
        .map(comp => {
            const componentName = comp.exportedComponents[0];
            return `    '${comp.cardName}': ${componentName}`;
        })
        .join(',\n');

    const metadataEntries = components
        .map(comp => `    '${comp.cardName}': {
        displayName: '${comp.displayName || comp.cardName}',
        category: '${comp.category || 'general'}',
        filePath: '${comp.filePath}',
        generatedAt: '${new Date().toISOString()}'
    }`)
        .join(',\n');

    const fileContent = `/**
 * Auto-generated component registry
 * Generated at: ${new Date().toISOString()}
 *
 * This file is automatically generated by scripts/generateComponentRegistry.js
 * Do not edit manually - your changes will be overwritten
 */

${imports}

import { setBuildTimeComponents } from './BuildTimeRegistry';
import { ComponentType } from './ComponentRegistry';

// Auto-generated component map
export const GENERATED_COMPONENT_MAP: Record<string, ComponentType> = {
${componentEntries}
};

// Auto-generated metadata
export const GENERATED_COMPONENT_METADATA = {
${metadataEntries}
};

// Auto-initialize build-time components
setBuildTimeComponents(GENERATED_COMPONENT_MAP);

console.log(\`[GeneratedComponentMap] Initialized \${Object.keys(GENERATED_COMPONENT_MAP).length} build-time components\`);

export default GENERATED_COMPONENT_MAP;
`;

    return fileContent;
}

/**
 * –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
 */
async function generateRegistry() {
    console.log('üîç Scanning for UI components...');

    const allComponents = [];

    // –°–∫–∞–Ω–∏—Ä—É–µ–º –≤—Å–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    for (const pattern of config.scanDirs) {
        const files = glob.sync(pattern);
        console.log(`üìÅ Found ${files.length} files in pattern: ${pattern}`);

        for (const file of files) {
            try {
                const metadata = extractComponentMetadata(file);
                if (metadata) {
                    allComponents.push(metadata);
                    console.log(`‚úÖ Registered: ${metadata.cardName} (${metadata.filePath})`);
                }
            } catch (error) {
                console.warn(`‚ö†Ô∏è  Error processing ${file}:`, error.message);
            }
        }
    }

    console.log(`\nüìù Generating component registry file...`);
    console.log(`üìä Total components found: ${allComponents.length}`);

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–∞–π–ª
    const outputContent = generateComponentMapFile(allComponents);
    const outputPath = path.resolve(config.outputFile);

    // –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    const outputDir = path.dirname(outputPath);
    if (!fs.existsSync(outputDir)) {
        fs.mkdirSync(outputDir, { recursive: true });
    }

    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ñ–∞–π–ª
    fs.writeFileSync(outputPath, outputContent, 'utf8');

    console.log(`‚úÖ Generated component registry: ${outputPath}`);
    console.log(`üéâ Registry generation completed successfully!`);

    return {
        componentsCount: allComponents.length,
        outputPath
    };
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —Ñ–∞–π–ª –≤—ã–∑–≤–∞–Ω –Ω–∞–ø—Ä—è–º—É—é
if (require.main === module) {
    generateRegistry().catch(error => {
        console.error('‚ùå Registry generation failed:', error);
        process.exit(1);
    });
}

module.exports = {
    generateRegistry,
    extractComponentMetadata,
    config
};